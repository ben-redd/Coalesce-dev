
    {% for test in node.tests if config.testsEnabled %}
        {% if test.runOrder == 'Before' %}
            {{ test_stage(test.name, test.continueOnFailure) }}
            {{ test.templateString }}
        {% endif %}
    {% endfor %}

{% if node.materializationType == 'table' %}
	{% if config.preSQL %}
		{{ stage('Pre-SQL') }}
		{{ config.preSQL }}
	
	{% endif %}

			
	{{ stage('Merge Link') }}
	MERGE INTO {{ ref_no_link(node.location.name, node.name) }} "TGT" USING
	(
		{% for source in sources %}
		SELECT
		{% for col in source.columns %}
            {{ get_source_transform(col) }} AS "{{ col.name }}"
			{%- if not loop.last -%}, {% endif %}
		{% endfor %}

		{{ source.join }}

		{% if not loop.last %}
			{{ config.insertStrategy }}
		{% endif %}
	{% endfor %}
	)
	AS "SRC"
	ON
	{% for col in sources[0].columns if (col.sourceColumns[0] 
                                        and col.sourceColumns[0].column 
                                        and col.sourceColumns[0].column.isLinkHash
                                        ) -%}
		{% if not loop.first %}
			AND
		{% endif %}
		"SRC"."{{ col.name }}" = "TGT"."{{ col.name }}"
	{% endfor %}
	WHEN NOT MATCHED THEN
	INSERT
	(
		{% for col in columns %}
			"{{ col.name }}"
			{%- if not loop.last -%}, {% endif %}
		{% endfor %}
	) VALUES
	(
		{% for col in columns %}
			"SRC"."{{ col.name }}"
			{%- if not loop.last -%}, {% endif %}
		{% endfor %}
	)

	{% if config.postSQL %}
		{{ stage('Post-SQL') }}
		{{ config.postSQL }}	
	{% endif %}
{% endif %}

{% if config.testsEnabled %}
	{% for test in node.tests %}
		{% if test.runOrder == 'After' %}
			{{ test_stage(test.name, test.continueOnFailure) }}
			{{ test.templateString }}
        {% endif %}
	{% endfor %}

	{% for column in columns %}
		{% for test in column.tests %}
			{{ test_stage(column.name + ": " + test.name) }}
			{{ test.templateString }}
		{% endfor %}
	{% endfor %}
{% endif %}
			